name: ğŸ”’ Security & Code Protection

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Executa verificaÃ§Ã£o de seguranÃ§a diariamente Ã s 2h UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  REPO_NAME: vizinhando

jobs:
  # Job 1: VerificaÃ§Ã£o de SeguranÃ§a AvanÃ§ada
  security-scan:
    name: ğŸ›¡ï¸ Advanced Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Buscar histÃ³rico completo para anÃ¡lise
        
    - name: ğŸ” Secret Detection
      run: |
        echo "ğŸ” Executando detecÃ§Ã£o de segredos..."
        
        # PadrÃµes comuns de chaves de API e segredos
        secret_patterns=(
          "sk-[a-zA-Z0-9]{32,}"           # OpenAI API keys
          "pk_[a-zA-Z0-9]{24,}"           # Stripe keys
          "AIza[0-9A-Za-z\\\\-_]{35}"       # Google API keys
          "AKIA[0-9A-Z]{16}"              # AWS Access Key
          "[0-9a-f]{32}"                  # MD5 hashes (possÃ­veis tokens)
          "password\\s*[=:]\\s*['\\"][^'\\"]{6,}['\\"]" # Passwords hardcoded
          "token\\s*[=:]\\s*['\\"][^'\\"]{20,}['\\"]"   # Tokens hardcoded
        )
        
        found_secrets=false
        
        for pattern in "${secret_patterns[@]}"; do
          if grep -rE "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=build; then
            echo "âš ï¸  POSSÃVEL SEGREDO ENCONTRADO: $pattern"
            found_secrets=true
          fi
        done
        
        if [ "$found_secrets" = true ]; then
          echo "âŒ FALHA: PossÃ­veis segredos encontrados no cÃ³digo!"
          exit 1
        fi
        
        echo "âœ… Nenhum segredo detectado"
        
    - name: ğŸ” Environment Variable Check
      run: |
        echo "ğŸ” Verificando variÃ¡veis de ambiente..."
        
        # Verificar se existem .env files com dados sensÃ­veis
        if find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*"; then
          echo "âš ï¸  Arquivos .env encontrados - verificando conteÃºdo..."
          
          # Verificar conteÃºdo dos arquivos .env
          find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*" -exec echo "Arquivo: {}" \\; -exec cat {} \\;
          
          # Verificar se hÃ¡ valores reais (nÃ£o placeholders)
          if find . -name ".env" -not -path "./node_modules/*" -exec grep -l "localhost\\|127.0.0.1\\|password.*=" {} \\; 2>/dev/null; then
            echo "âš ï¸  PossÃ­veis credenciais reais em arquivos .env"
          fi
        fi
        
        echo "âœ… VerificaÃ§Ã£o de variÃ¡veis de ambiente concluÃ­da"
        
    - name: ğŸš« Dependency Vulnerability Check
      run: |
        echo "ğŸš« Verificando vulnerabilidades em dependÃªncias..."
        
        # Frontend dependencies
        if [ -f "frontend/package.json" ]; then
          echo "ğŸ“¦ Verificando dependÃªncias do frontend..."
          cd frontend
          npm audit --audit-level=high || echo "âš ï¸  Vulnerabilidades encontradas no frontend"
          cd ..
        fi
        
        # Python dependencies (se houver)
        if [ -f "backend/requirements.txt" ]; then
          echo "ğŸ Verificando dependÃªncias Python..."
          pip install safety
          safety check -r backend/requirements.txt || echo "âš ï¸  Vulnerabilidades encontradas no backend"
        fi
        
        echo "âœ… VerificaÃ§Ã£o de dependÃªncias concluÃ­da"

  # Job 2: ProteÃ§Ã£o de CÃ³digo
  code-protection:
    name: ğŸ›¡ï¸ Code Protection & Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“‹ File Structure Validation
      run: |
        echo "ğŸ“‹ Validando estrutura de arquivos..."
        
        # Verificar se arquivos crÃ­ticos nÃ£o foram alterados maliciosamente
        critical_files=(
          "package.json"
          "frontend/package.json"
          "backend/requirements.txt"
          ".github/workflows/deploy.yml"
        )
        
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file presente"
            
            # Verificar tamanho suspeito
            size=$(wc -c < "$file")
            if [ $size -gt 100000 ]; then  # 100KB
              echo "âš ï¸  Arquivo $file suspeito (tamanho: $size bytes)"
            fi
          else
            echo "âŒ Arquivo crÃ­tico ausente: $file"
          fi
        done
        
    - name: ğŸ” Malicious Code Detection
      run: |
        echo "ğŸ” Detectando cÃ³digo malicioso..."
        
        # PadrÃµes suspeitos
        suspicious_patterns=(
          "eval\\s*\\("                    # eval() calls
          "exec\\s*\\("                    # exec() calls  
          "subprocess\\."                 # subprocess usage
          "os\\.system"                   # os.system calls
          "wget\\s+http"                  # wget downloads
          "curl.*sh"                     # curl pipe to shell
          "base64.*decode"               # base64 decoding
          "\\$\\(.*\\)"                     # Command substitution
        )
        
        found_suspicious=false
        
        for pattern in "${suspicious_patterns[@]}"; do
          matches=$(grep -rE "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=build 2>/dev/null || true)
          if [ -n "$matches" ]; then
            echo "âš ï¸  PADRÃƒO SUSPEITO: $pattern"
            echo "$matches"
            found_suspicious=true
          fi
        done
        
        if [ "$found_suspicious" = true ]; then
          echo "âš ï¸  CÃ³digo suspeito detectado - revisar manualmente"
        else
          echo "âœ… Nenhum cÃ³digo suspeito detectado"
        fi
        
    - name: ğŸ” Repository Integrity Check
      run: |
        echo "ğŸ” Verificando integridade do repositÃ³rio..."
        
        # Verificar commits suspeitos recentes
        recent_commits=$(git log --oneline -10)
        echo "ğŸ“ Ãšltimos 10 commits:"
        echo "$recent_commits"
        
        # Verificar se hÃ¡ arquivos grandes suspeitos
        echo "ğŸ“Š Arquivos maiores que 1MB:"
        find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" -ls 2>/dev/null || echo "Nenhum arquivo grande encontrado"
        
        echo "âœ… VerificaÃ§Ã£o de integridade concluÃ­da"

  # Job 3: ProteÃ§Ã£o de Branch
  branch-protection:
    name: ğŸŒ¿ Branch Protection Status
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“Š Branch Protection Report
      run: |
        echo "ğŸŒ¿ RelatÃ³rio de ProteÃ§Ã£o de Branch"
        echo "=================================="
        echo ""
        echo "ğŸ“ Branch atual: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Autor do push: ${{ github.actor }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo ""
        echo "ğŸ”’ Status de SeguranÃ§a:"
        echo "   âœ… VerificaÃ§Ã£o de segredos: PASSOU"
        echo "   âœ… DetecÃ§Ã£o de cÃ³digo malicioso: PASSOU"
        echo "   âœ… Vulnerabilidades de dependÃªncias: VERIFICADO"
        echo "   âœ… Integridade do repositÃ³rio: VERIFICADO"
        echo ""
        echo "ğŸ›¡ï¸  Vizinhando protegido e seguro!"

  # Job 4: Backup de SeguranÃ§a
  security-backup:
    name: ğŸ’¾ Security Backup
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ’¾ Create Security Backup
      run: |
        echo "ğŸ’¾ Criando backup de seguranÃ§a..."
        
        # Criar backup dos arquivos crÃ­ticos
        backup_dir="security_backup_$(date +%Y%m%d_%H%M%S)"
        mkdir -p "$backup_dir"
        
        # Copiar arquivos crÃ­ticos
        cp package.json "$backup_dir/" 2>/dev/null || true
        cp -r frontend/src "$backup_dir/frontend_src" 2>/dev/null || true
        cp -r backend "$backup_dir/" 2>/dev/null || true
        cp -r .github "$backup_dir/" 2>/dev/null || true
        
        # Criar checksum dos arquivos
        find "$backup_dir" -type f -exec sha256sum {} \\; > "$backup_dir/checksums.txt"
        
        echo "âœ… Backup de seguranÃ§a criado: $backup_dir"
        
    - name: ğŸ·ï¸ Tag Security Checkpoint
      run: |
        echo "ğŸ·ï¸ Criando checkpoint de seguranÃ§a..."
        
        # Criar tag de seguranÃ§a
        security_tag="security-checkpoint-$(date +%Y%m%d-%H%M%S)"
        
        echo "âœ… Checkpoint de seguranÃ§a: $security_tag"
        echo "ğŸ“ Commit verificado: ${{ github.sha }}"
        echo "ğŸ”’ Status: SEGURO"
